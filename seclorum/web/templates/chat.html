<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <title>Seclorum Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        .panel { background: rgba(255, 255, 255, 0.7); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); border-radius: 0.5rem; transition: all 0.3s ease; }
        .dark .panel { background: rgba(30, 41, 59, 0.7); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); }
        .active-agent { background: rgba(255, 255, 255, 0.95); }
        .dark .active-agent { background: rgba(30, 41, 59, 0.95); }
        .glow::after { content: ''; position: absolute; top: -10px; left: -10px; right: -10px; bottom: -10px; background: radial-gradient(circle, rgba(147, 197, 253, 0.2), transparent); z-index: -1; filter: blur(10px); }
        .dark .glow::after { background: radial-gradient(circle, rgba(59, 130, 246, 0.2), transparent); }
        .agent-output { max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-100 to-purple-100 dark:from-slate-800 dark:to-slate-900 font-sans p-6 transition-colors duration-300">
    <div class="max-w-5xl mx-auto flex space-x-6" x-data="appData">
        <div class="w-1/3 flex flex-col space-y-4">
            <div class="panel p-4 glow h-96 flex flex-col">
                <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-100 mb-4">Chat History</h2>
                <div class="flex-1 overflow-y-auto flex flex-col-reverse" x-ref="history">
                    <template x-for="(entry, index) in conversationHistory.slice().reverse()" :key="index">
                        <div class="panel mb-2 p-3" x-text="entry"></div>
                    </template>
                </div>
            </div>
            <div class="panel p-4 glow" x-data="{ input: '', mode: '{{ mode }}', history: ['Write a haiku', 'Whatâ€™s 2+2?', 'Tell a joke'] }">
                <form @submit.prevent="submitInput(input)">
                    <div class="relative flex space-x-2">
                        <input
                            type="text"
                            x-model="input"
                            list="task-history"
                            :placeholder="mode === 'task' ? 'Enter a task (e.g., Write a haiku)' : 'Chat with agent'"
                            class="w-full p-2 border rounded-lg bg-white/80 dark:bg-slate-600 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-400"
                        >
                        <datalist id="task-history">
                            <template x-for="item in history" :key="item">
                                <option x-text="item"></option>
                            </template>
                        </datalist>
                        <button type="button" @click="mode = mode === 'task' ? 'agent' : 'task'; window.location.href = '/chat?mode=' + mode" class="p-2 bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-white rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500">
                            <span x-text="mode === 'task' ? 'Agent' : 'Task'"></span>
                        </button>
                    </div>
                    <input type="submit" value="Send" class="mt-2 w-full p-2 bg-blue-400 dark:bg-blue-600 text-white rounded-lg hover:bg-blue-500 dark:hover:bg-blue-700 opacity-75">
                </form>
            </div>
        </div>
        <div class="w-2/3 panel p-6 glow" x-data="{ selectedAgent: null }">
            <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-100 mb-4">Agents</h2>
            <div class="space-y-4">
                <template x-for="(agent, id) in agents" :key="id">
                    <div class="panel p-3 agent-output" :class="{ 'active-agent': selectedAgent === id }" @click="selectedAgent = id">
                        <strong>Agent {{ id }}:</strong>
                        <div x-text="agent.output.replace(/\n/g, '<br>')" class="text-gray-600 dark:text-gray-400"></div>
                    </div>
                </template>
            </div>
        </div>
    </div>
    <p class="mt-6 text-center"><a href="/settings" class="text-blue-500 dark:text-blue-400 hover:underline">Settings</a> | <a href="/dashboard" class="text-blue-500 dark:text-blue-400 hover:underline">Dashboard</a></p>
<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('appData', () => ({
            darkMode: localStorage.getItem('darkMode') === 'true',
            conversationHistory: {{ conversation_history|tojson|safe }}.split('\n'),
            agents: {{ agents|tojson|safe }},
            tasks: {{ tasks|tojson|safe }},
            init() {
                document.documentElement.classList.toggle('dark', this.darkMode);
                const socket = io('http://127.0.0.1:5000');
                socket.on('connect', () => console.log('SocketIO connected'));
                socket.on('task_update', (data) => {
                    console.log('Task update:', data);
                    if (data.status === 'assigned') {
                        this.agents[data.task_id] = { id: data.task_id, output: 'Pending...' };
                    } else if (data.status === 'completed' || data.status === 'failed') {
                        this.agents[data.task_id].output = data.result;
                    }
                });
            },
            submitInput(input) {
                if (input) {
                    fetch('/chat?mode={{ mode }}', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: 'input=' + encodeURIComponent(input)
                    }).then(() => {
                        this.$refs.history.scrollTop = 0;
                        Alpine.$data(this.$root.querySelector('div[x-data*=\"input\"]')).input = '';
                    });
                }
            }
        }));
    });
</script>
</body>
</html>
