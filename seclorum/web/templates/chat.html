<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <title>Seclorum Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        .panel { background: rgba(255, 255, 255, 0.7); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); border-radius: 0.5rem; transition: all 0.3s ease; }
        .dark .panel { background: rgba(30, 41, 59, 0.7); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); }
        .active-agent { background: rgba(255, 255, 255, 0.95); }
        .dark .active-agent { background: rgba(30, 41, 59, 0.95); }
        .glow::after { content: ''; position: absolute; top: -10px; left: -10px; right: -10px; bottom: -10px; background: radial-gradient(circle, rgba(147, 197, 253, 0.2), transparent); z-index: -1; filter: blur(10px); }
        .dark .glow::after { background: radial-gradient(circle, rgba(59, 130, 246, 0.2), transparent); }
        .agent-output { max-height: 200px; overflow-y: auto; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .history-container { max-height: calc(100vh - 20rem); } /* Adjust based on input + footer height */
    </style>
</head>
<body class="bg-gradient-to-br from-blue-100 to-purple-100 dark:from-slate-800 dark:to-slate-900 font-sans transition-colors duration-300 flex flex-col h-screen">
    <div class="flex-1 flex flex-col max-w-5xl mx-auto p-4 overflow-hidden" x-data="appData">
        <div class="flex flex-col h-full space-y-4">
            <div class="flex space-x-4 flex-1 overflow-hidden">
                <div class="w-5/12 flex flex-col space-y-4">
                    <div class="panel p-4 glow flex flex-col flex-1">
                        <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-100 mb-4" x-text="mode === 'user' ? 'Chat History' : 'Available Agents'"></h2>
                        <div class="flex-1 overflow-y-auto no-scrollbar flex flex-col history-container" x-ref="history" @mousedown="startDrag($event)" @mousemove="drag($event)" @mouseup="stopDrag()" @mouseleave="stopDrag()" @wheel="wheelScroll($event)">
                            <div class="flex-1"></div> <!-- Spacer to push content to bottom -->
                            <template x-if="mode === 'user'">
                                <template x-for="(entry, index) in conversationHistory" :key="index">
                                    <div class="panel mb-2 p-3" x-text="entry"></div>
                                </template>
                            </template>
                            <template x-if="mode === 'agent'">
                                <div>
                                    <div class="panel mb-2 p-3 cursor-pointer" :class="{ 'active-agent': selectedAgent === 'master' }" @click="selectedAgent = 'master'; saveState()" x-text="'MasterNode: Coordinating agents'"></div>
                                    <template x-for="(agent, id) in agents" :key="id">
                                        <div class="panel mb-2 p-3 cursor-pointer" :class="{ 'active-agent': selectedAgent === id }" @click="selectedAgent = id; saveState()" x-text="`Agent ${id}: ${agent.description || 'Idle'}`"></div>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </div>
                    <div class="panel p-4 glow shrink-0 h-32"> <!-- Fixed height for input panel -->
                        <form @submit.prevent="submitInput(input)" method="POST" :action="'/chat?mode=' + mode + (selectedAgent ? '&task_id=' + selectedAgent : '')">
                            <div class="flex flex-col space-y-2">
                                <textarea name="input" x-model="input" :placeholder="mode === 'user' ? 'Chat with agent' : 'Enter agent command or task'" class="w-full p-2 border rounded-lg bg-white/80 dark:bg-slate-600 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-400 resize-y min-h-[2.5rem] max-h-[8rem]" @input="adjustHeight($event.target)"></textarea>
                                <div class="flex space-x-2">
                                    <input type="submit" value="Send" class="flex-1 p-2 bg-blue-900 dark:bg-blue-800 text-white rounded-lg hover:bg-blue-800 dark:hover:bg-blue-700 opacity-75">
                                    <button type="button" @click="toggleMode()" class="p-2 bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-white rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500">
                                        <span x-text="mode === 'user' ? 'User' : 'Agent'"></span>
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="w-7/12 panel p-6 glow flex-1">
                    <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-100 mb-4" x-text="mode === 'user' ? 'Agents' : 'Agent Details'"></h2>
                    <div class="space-y-4 h-full overflow-y-auto">
                        <template x-if="mode === 'user'">
                            <template x-for="(agent, id) in agents" :key="id">
                                <div class="panel p-3 agent-output" :class="{ 'active-agent': selectedAgent === id }" @click="selectedAgent = id">
                                    <strong>Agent {{ id }}:</strong>
                                    <div x-text="agent.result ? agent.result.replace(/\n/g, '<br>') : agent.output ? agent.output.replace(/\n/g, '<br>') : 'No output'" class="text-gray-600 dark:text-gray-400"></div>
                                </template>
                            </template>
                        </template>
                        <template x-if="mode === 'agent'">
                            <div class="panel p-3 agent-output">
                                <template x-if="selectedAgent">
                                    <div>
                                        <strong x-text="selectedAgent === 'master' ? 'MasterNode' : 'Agent ' + selectedAgent"></strong>
                                        <div x-text="(agentHistories[selectedAgent] || 'No history yet').replace(/\n/g, '<br>')" class="text-gray-600 dark:text-gray-400"></div>
                                        <div class="mt-2 text-sm text-gray-500 dark:text-gray-400" x-text="selectedAgent === 'master' ? 'Description: Coordinates agent graph' : `Description: ${agents[selectedAgent]?.description || 'No description'}`"></div>
                                    </div>
                                </template>
                                <template x-if="!selectedAgent">
                                    <div class="text-gray-600 dark:text-gray-400">Select an agent or MasterNode from the left panel.</div>
                                </template>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <footer class="max-w-5xl mx-auto text-center py-4 shrink-0">
        <a :href="'/settings?mode=' + mode + (selectedAgent ? '&task_id=' + selectedAgent : '')" class="text-blue-500 dark:text-blue-400 hover:underline">Settings</a> | 
        <a :href="'/dashboard?mode=' + mode + (selectedAgent ? '&task_id=' + selectedAgent : '')" class="text-blue-500 dark:text-blue-400 hover:underline">Dashboard</a> | 
        <a :href="'/chat?mode=' + mode + (selectedAgent ? '&task_id=' + selectedAgent : '')" class="text-blue-500 dark:text-blue-400 hover:underline">Chat</a>
    </footer>
<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('appData', () => ({
            darkMode: localStorage.getItem('darkMode') === 'true',
            mode: localStorage.getItem('chatMode') || new URLSearchParams(window.location.search).get('mode') || ('{{ mode }}' === 'agent' ? 'agent' : 'user'),
            conversationHistory: ({{ conversation_history|tojson|safe }} || '').split('\n').filter(line => line.trim()),
            agents: {{ agents|tojson|safe }} || {},
            tasks: {{ tasks|tojson|safe }} || {},
            agentHistories: {{ agent_histories|tojson|safe }} || {},
            selectedAgent: localStorage.getItem('selectedAgent') || ('{{ selected_task_id }}' === '' ? null : '{{ selected_task_id }}'),
            input: '',
            isDragging: false,
            startY: 0,
            scrollTop: 0,
            scrollSpeed: 1.5,
            init() {
                console.log('Initial mode:', this.mode, 'selectedAgent:', this.selectedAgent);
                document.documentElement.classList.toggle('dark', this.darkMode);
                this.updateModeFromURL();
                const socket = io('http://127.0.0.1:5000');
                socket.on('connect', () => console.log('SocketIO connected'));
                socket.on('disconnect', () => console.log('SocketIO disconnected'));
                socket.on('task_update', (data) => {
                    console.log('Task update:', data);
                    if (data.status === 'assigned') {
                        this.agents[data.task_id] = { output: 'Pending...', description: data.description };
                    } else if (data.status === 'completed' || data.status === 'failed') {
                        this.agents[data.task_id] = data;
                    }
                });
                socket.on('chat_update', (data) => {
                    console.log('Chat update:', data);
                    this.conversationHistory.push(`User: ${data.prompt}`);
                    this.conversationHistory.push(`Agent: ${data.response}`);
                    if (data.task_id && this.agentHistories[data.task_id] !== undefined) {
                        this.agentHistories[data.task_id] = (this.agentHistories[data.task_id] ? this.agentHistories[data.task_id] + '\n' : '') + `User: ${data.prompt}\nAgent: ${data.response}`;
                    }
                    this.$refs.history.scrollTop = this.$refs.history.scrollHeight;
                });
                socket.on('reset_storage', () => {
                    console.log('Resetting local storage');
                    localStorage.clear();
                    this.agents = {};
                    this.conversationHistory = [];
                    this.tasks = {};
                    this.agentHistories = {};
                    this.mode = 'user';
                    this.selectedAgent = null;
                });
            },
            saveState() {
                localStorage.setItem('chatMode', this.mode);
                localStorage.setItem('selectedAgent', this.selectedAgent);
                window.history.pushState({}, document.title, '/chat?mode=' + this.mode + (this.selectedAgent ? '&task_id=' + this.selectedAgent : ''));
            },
            updateModeFromURL() {
                const urlParams = new URLSearchParams(window.location.search);
                const modeFromURL = urlParams.get('mode');
                if (modeFromURL && ['user', 'agent'].includes(modeFromURL)) {
                    this.mode = modeFromURL;
                    this.saveState();
                }
            },
            toggleMode() {
                this.mode = this.mode === 'user' ? 'agent' : 'user';
                this.selectedAgent = null;
                this.saveState();
                window.location.href = '/chat?mode=' + this.mode;
            },
            submitInput(input) {
                if (input.trim()) {
                    console.log('Submitting:', input, 'Mode:', this.mode, 'Task ID:', this.selectedAgent);
                    fetch('/chat?mode=' + this.mode + (this.selectedAgent ? '&task_id=' + this.selectedAgent : ''), {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: 'input=' + encodeURIComponent(input)
                    }).then(response => {
                        console.log('Fetch response:', response.status);
                        if (response.ok) {
                            this.input = '';
                            if (this.mode === 'task') {
                                console.log('Reloading for task mode');
                                window.location.reload();
                            }
                        }
                    }).catch(error => console.error('Fetch error:', error));
                }
            },
            adjustHeight(el) {
                el.style.height = 'auto';
                el.style.height = `${el.scrollHeight}px`;
            },
            startDrag(event) {
                if (event.button === 0) {
                    this.isDragging = true;
                    this.startY = event.pageY - this.$refs.history.getBoundingClientRect().top;
                    this.scrollTop = this.$refs.history.scrollTop;
                    event.preventDefault();
                }
            },
            drag(event) {
                if (this.isDragging) {
                    const delta = (this.startY - (event.pageY - this.$refs.history.getBoundingClientRect().top)) * this.scrollSpeed;
                    this.$refs.history.scrollTop = this.scrollTop + delta;
                    event.preventDefault();
                }
            },
            stopDrag() {
                this.isDragging = false;
            },
            wheelScroll(event) {
                this.$refs.history.scrollTop += event.deltaY * this.scrollSpeed;
                event.preventDefault();
            }
        }));
    });
</script>
</body>
</html>
