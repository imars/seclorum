<!DOCTYPE html>
<html>
<head>
    <title>Seclorum Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4" x-data="{ tasks: {{ tasks | tojson }}, history: ['Write a haiku', 'Whatâ€™s 2+2?', 'Tell a joke'], newTask: '' }">
        <h1 class="text-2xl font-bold mb-4">Seclorum Chat</h1>
        
        <!-- Chat Input with History -->
        <form action="/chat" method="POST" class="mb-4">
            <div class="relative">
                <input 
                    type="text" 
                    name="task" 
                    x-model="newTask" 
                    @keydown.enter.prevent="submitTask()" 
                    @input="filterHistory()" 
                    list="task-history" 
                    class="w-full p-2 border rounded" 
                    placeholder="Enter your task..."
                >
                <datalist id="task-history">
                    <template x-for="item in history" :key="item">
                        <option x-text="item"></option>
                    </template>
                </datalist>
            </div>
            <button type="submit" class="mt-2 bg-blue-500 text-white p-2 rounded">Submit Task</button>
        </form>

        <!-- Task History -->
        <div class="mb-4">
            <h2 class="text-xl font-semibold">Task History</h2>
            <ul class="list-disc pl-5">
                <template x-for="(task, id) in tasks" :key="id">
                    <li x-text="task.description + ' - ' + task.status"></li>
                </template>
            </ul>
        </div>

        <!-- Agent Output -->
        <div>
            <h2 class="text-xl font-semibold">Agent Output</h2>
            <div x-ref="output" class="bg-white p-4 rounded shadow"></div>
        </div>

        <script>
            document.addEventListener('alpine:init', () => {
                Alpine.data('chat', () => ({
                    submitTask() {
                        if (this.newTask) {
                            this.history = [this.newTask, ...this.history.slice(0, 9)]; // Keep last 10
                            this.$el.querySelector('form').submit();
                        }
                    },
                    filterHistory() {
                        // Optional: Filter history based on input (not implemented here)
                    }
                }));
            });

            const socket = io.connect('http://' + document.domain + ':' + location.port);
            socket.on('connect', () => {
                console.log('SocketIO connected');
            });
            socket.on('debug', (data) => {
                console.log('Debug:', data);
            });
            socket.on('task_update', (data) => {
                console.log('Task update:', data);
                const output = document.querySelector('[x-ref="output"]');
                if (data.status === 'completed') {
                    output.innerHTML += `<p><strong>Task ${data.task_id}:</strong> ${data.result}</p>`;
                }
                Alpine.store('chat').tasks[data.task_id] = data;
            });
        </script>
    </div>
</body>
</html>
